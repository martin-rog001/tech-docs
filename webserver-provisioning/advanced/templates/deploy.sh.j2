#!/bin/bash
# Deployment Script for {{ server_name }}
# Generated by Ansible

set -e

WEB_ROOT="{{ web_root }}"
BACKUP_DIR="/backup/webroot"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "================================"
echo "Web Deployment Script"
echo "================================"
echo "Server: {{ server_name }}"
echo "Time: $(date)"
echo ""

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Backup current web root
echo "Creating backup..."
tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C "$WEB_ROOT" . 2>/dev/null || echo "No existing files to backup"

# Keep only last 5 backups
echo "Cleaning old backups..."
cd "$BACKUP_DIR"
ls -t | tail -n +6 | xargs -r rm --

# Example: Pull from git repository
# echo "Pulling latest code..."
# cd "$WEB_ROOT"
# git pull origin main

# Example: Install dependencies
{% if enable_nodejs %}
# npm install --production
{% endif %}

{% if enable_php %}
# composer install --no-dev --optimize-autoloader
{% endif %}

# Set proper permissions
echo "Setting permissions..."
chown -R {{ app_user }}:{{ app_group }} "$WEB_ROOT"
find "$WEB_ROOT" -type d -exec chmod 755 {} \;
find "$WEB_ROOT" -type f -exec chmod 644 {} \;

# Restart services if needed
{% if enable_php %}
echo "Restarting PHP-FPM..."
systemctl restart php{{ php_version }}-fpm
{% endif %}

{% if enable_nodejs %}
# echo "Restarting Node.js application..."
# pm2 restart all
{% endif %}

echo "Reloading NGINX..."
nginx -t && systemctl reload nginx

echo ""
echo "================================"
echo "Deployment completed successfully!"
echo "================================"
