#!/bin/bash
# Backup Script for {{ server_name }}
# Generated by Ansible

set -e

BACKUP_DIR="/backup"
WEB_ROOT="{{ web_root }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=30

echo "Starting backup at $(date)"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup web files
echo "Backing up web files..."
tar -czf "$BACKUP_DIR/webroot_$TIMESTAMP.tar.gz" -C "$WEB_ROOT" .

# Backup NGINX configuration
echo "Backing up NGINX configuration..."
tar -czf "$BACKUP_DIR/nginx_$TIMESTAMP.tar.gz" /etc/nginx/

# Backup SSL certificates
{% if enable_ssl %}
echo "Backing up SSL certificates..."
tar -czf "$BACKUP_DIR/ssl_$TIMESTAMP.tar.gz" /etc/ssl/ /etc/letsencrypt/ 2>/dev/null || true
{% endif %}

# Remove old backups
echo "Removing backups older than $RETENTION_DAYS days..."
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

# Display backup info
echo "Backup completed at $(date)"
echo "Backup location: $BACKUP_DIR"
du -sh "$BACKUP_DIR"/*_$TIMESTAMP.tar.gz
